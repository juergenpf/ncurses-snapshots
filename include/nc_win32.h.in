/****************************************************************************
 * Copyright 2018-2024,2025 Thomas E. Dickey                                *
 * Copyright 2008-2010,2017 Free Software Foundation, Inc.                  *
 *                                                                          *
 * Permission is hereby granted, free of charge, to any person obtaining a  *
 * copy of this software and associated documentation files (the            *
 * "Software"), to deal in the Software without restriction, including      *
 * without limitation the rights to use, copy, modify, merge, publish,      *
 * distribute, distribute with modifications, sublicense, and/or sell       *
 * copies of the Software, and to permit persons to whom the Software is    *
 * furnished to do so, subject to the following conditions:                 *
 *                                                                          *
 * The above copyright notice and this permission notice shall be included  *
 * in all copies or substantial portions of the Software.                   *
 *                                                                          *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS  *
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF               *
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.   *
 * IN NO EVENT SHALL THE ABOVE COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,   *
 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR    *
 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR    *
 * THE USE OR OTHER DEALINGS IN THE SOFTWARE.                               *
 *                                                                          *
 * Except as contained in this notice, the name(s) of the above copyright   *
 * holders shall not be used in advertising or otherwise to promote the     *
 * sale, use or other dealings in this Software without prior written       *
 * authorization.                                                           *
 ****************************************************************************/

/****************************************************************************
 * Author: Thomas Dickey, 2008-on                                           *
 ****************************************************************************/

/* $Id: nc_win32.h.in,v 1.19 2025/12/26 23:32:43 tom Exp $ */

#ifndef NC_WIN32_H
#define NC_WIN32_H 1

#include <ncurses_cfg.h>

#if defined(_WIN32) || defined(_WIN64) 

#ifndef _NC_WINDOWS_NATIVE
#define _NC_WINDOWS_NATIVE
#endif

#ifdef TERMIOS
#error TERMIOS must not be defined on Windows
#endif

/*
   Minimum requirement for named pipes is Windows Vista or Server2008,
   aka Windows NT 6.0
*/
#ifdef WINVER
#  if WINVER < 0x0600
#    error WINVER must at least be 0x0600
#  endif
#else
#  define WINVER 0x0600
#endif

#include <windows.h>

#if HAVE_SYS_TIME_H
#include <sys/time.h>		/* for struct timeval */
#endif

#ifdef _MSC_VER
#include <winsock2.h>		/* for struct timeval */
#endif

#include <stdint.h>		/* for uint32_t */

/*
 * Allow for build-override, e.g., MinGW used "cygwin".
 */
#ifndef DEFAULT_TERM_ENV
#define DEFAULT_TERM_ENV "ms-terminal"
#endif

#undef VALID_TERM_ENV
#define VALID_TERM_ENV(term_env, no_terminal) \
	(term_env = (NonEmpty(term_env) \
		      ? term_env \
		      : DEFAULT_TERM_ENV), \
	 NonEmpty(term_env))

#include <ncurses_dll.h>

#ifdef __cplusplus
extern "C" {
#endif

#define TTY_MODE_UNSPECIFIED 0
#define TTY_MODE_SHELL 1
#define TTY_MODE_PROGRAM 2
#define TTY_MODE_AUTO 3
// This is our equivalent to termios (aka TTY)
typedef struct
{
    DWORD dwFlagIn;        /* Input Handle Console mode flags */
    DWORD dwFlagOut;       /* Output Handle Console mode flags */
    uint8_t kind;          /* 0=unspecified, 1=shell, 2=prog, 3=auto */
} ConsoleMode;

#if defined(CURSES_PRIV_H) || defined(TEST_PRIV_H) || 1

#if !HAVE_CLOCK_GETTIME && !HAVE_GETTIMEOFDAY
extern NCURSES_EXPORT(int) _nc_gettimeofday(struct timeval *, void *);
#undef HAVE_GETTIMEOFDAY
#define HAVE_GETTIMEOFDAY 2
#define gettimeofday(tv,tz) _nc_gettimeofday(tv,tz)
#endif

#if USE_WIDEC_SUPPORT && !defined(_UCRT)
#ifndef UTF8_MAX_BYTES
#define UTF8_MAX_BYTES 4 /* Maximum bytes in UTF-8 sequence */
#endif
extern NCURSES_EXPORT(size_t) _nc_wchar_to_utf8(wchar_t wc, char utf8[UTF8_MAX_BYTES]);
NCURSES_EXPORT(int) _nc_assemble_utf8_input(unsigned char byte, wchar_t *wch);
#endif /* USE_WIDEC_SUPPORT && !defined(_UCRT) */

// This is for future use in an implementation that may make use of the Windows Console API 
// in a more direct way, and is not intended to be a public documentation at the moment.
#define NC_CONHOST_FLAG_SUPPORT_EVENTS 0x0001
#define NC_CONHOST_FLAG_MASK (NC_CONHOST_FLAG_SUPPORT_EVENTS)

#ifndef EVENTLIST_2nd
 #define EVENTLIST_2nd(param) /* nothing */
#endif

// --- Poll-Events ---
#ifndef POLLIN
#define POLLIN  0x0001  // Input available (for stdin/pipe)
#define POLLOUT 0x0004  // Output available (for stdout/pipe, optional)
#define POLLERR 0x0008  // Error condition (for stdin/pipe)
#endif

// --- Structure similar to UNIX ---
struct pty_pollfd {
    int fd;         // only 0 (STDIN) supported)
    short events;   // events to check
    short revents;  // returned events
};

// --- Typ f√ºr Anzahl der FDs ---
typedef unsigned long nfds_t;

typedef struct {
  // Properties
    BOOL initialized;                /* Whether the console has been initialized */

    unsigned int conhost_flags;      /* Host configuration flags */
    
    ConsoleMode ttyflags;            /* The desired state of the console  */
    
    HANDLE ConsoleHandleIn;          /* Console Handle actually used for input operations */
    HANDLE ConsoleHandleOut;         /* Console Handle actually used for output operations */

    int sbi_lines;                   /* Cached console size */
    int sbi_cols;                    /* Cached console size */

  // Metods
    BOOL (*init)(int fdOut, int fdIn);                                /* Initialize with I/O file descriptors. fdIn maybe -1 in first call */
    void (*size)(int *Lines, int *Cols);                              /* Query console size. Safe to be called before init */ 
    BOOL (*check_resize)(void);                                       /* Return TRUE if the console has been resized */
    int (*setmode)(int fd, const ConsoleMode *arg);                   /* Our SET_TTY implementation */
    int (*getmode)(int fd, ConsoleMode *arg);                         /* Our GET_TTY implementation */
    int (*defmode )(ConsoleMode *arg, short kind);                    /* Used by shell-/prog-mode handling to manage start/stop of the I/O subsystem of ncurses */
    int (*flush)(int fd);                                             /* flush the console I/O stream denoted by the file descriptor */
    int (*read)(int fd, int *result);                                 /* Read bytes from the input stream. If wide characters are used, the UTF-8 assembly is done here */
    int (*write)(int fd, const void *buf, size_t count);              /* Write bytes to the output stream. If wide characters are used, the UTF-8 encoding is done here */
    int (*start_input_subsystem)(void);                               /* In prog mode, we control the input stream */
    int (*stop_input_subsystem)(void);                                /* In shell mode, we leave it to the C runtime */
    int (*poll)(struct pty_pollfd *fds, nfds_t nfds, int timeout_ms); /* Minimalistic clone of UNIX poll, just polling stdin console input */
  } ConsoleInfo;

// Guaranteed to be statically initialzed.
extern NCURSES_EXPORT_VAR(ConsoleInfo*) _nc_currentCONSOLE;
#define WINCONSOLE (*_nc_currentCONSOLE)

#endif /* defined(CURSES_PRIV_H) || defined(TEST_PRIV_H) */

#if !HAVE_WCWIDTH
#undef wcwidth
#define wcwidth(ucs) _nc_wcwidth((wchar_t)(ucs))
extern NCURSES_EXPORT(int) _nc_wcwidth(uint32_t);
#endif

#ifdef __cplusplus
}
#endif

#ifdef CURSES_PRIV_H	/* test.priv.h just needs the preceding */
#include <term.h>
#endif

#if USE_DOS_PATHS
NCURSES_EXPORT(const char *) _nc_to_dospath(const char *, char *);
#define FixupPathname(path) \
	char fixed_pathname[PATH_MAX]; \
	path = _nc_to_dospath(path, fixed_pathname)
#define FixupPathname2(path,buffer) \
	path = _nc_to_dospath(path, buffer)
#endif

#undef  ttyname
#define ttyname(fd) NULL

#endif /* _WIN32 || _WIN64 */

#endif /* NC_WIN32_H */
